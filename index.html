<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>School Chat Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.js"></script>
<style>
body{margin:0;font-family:'Segoe UI',Arial;background:#0b1020;color:white;}
header{padding:15px;text-align:center;font-size:20px;font-weight:bold;background:#0e1b36;box-shadow:0 2px 10px black;}
#container{display:flex;flex-direction:column;max-width:900px;margin:auto;height:100vh;}
#chat{flex:1;overflow-y:auto;padding:10px;}
.msg{margin-bottom:10px;}
.bubble{display:inline-block;padding:10px 14px;border-radius:14px;background:#13244a;max-width:80%;}
.me .bubble{background:#00e6b1;color:black;}
.name{font-size:12px;opacity:0.6;}
.time{font-size:10px;opacity:0.4;}
footer{display:flex;padding:10px;background:#081022;gap:8px;}
input{flex:1;padding:10px;border-radius:8px;border:none;outline:none;}
button{background:#00ffc8;color:black;font-weight:bold;padding:10px 16px;border-radius:8px;cursor:pointer;border:none;}
#rooms{margin:10px;display:flex;gap:8px;flex-wrap:wrap;}
.room-btn{background:#13244a;color:white;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;}
.room-btn.active{background:#00e6b1;color:black;}
#users{font-size:12px;opacity:0.6;margin:4px 10px;}
.typing{font-size:12px;opacity:0.5;margin-left:10px;}
</style>
</head>
<body>

<header>üåç School Chat Pro</header>
<div id="container">

<div id="rooms">
  <button class="room-btn active" data-room="global">Global</button>
  <button class="room-btn" data-room="math">Math</button>
  <button class="room-btn" data-room="science">Science</button>
</div>

<div style="padding:10px">
  <input id="name" placeholder="Your name">
</div>

<div id="users">Online: 0</div>
<div id="typing" class="typing"></div>
<div id="chat"></div>

<footer>
  <input id="msg" placeholder="Type message">
  <button id="emoji-btn">üòÄ</button>
  <button onclick="send()">Send</button>
</footer>
</div>

<script>
const SUPABASE_URL = "PASTE_PROJECT_URL_HERE";
const SUPABASE_KEY = "PASTE_PUBLIC_KEY_HERE";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const chat = document.getElementById("chat");
const usersDiv = document.getElementById("users");
const typingDiv = document.getElementById("typing");
const nameInput = document.getElementById("name");
const msgInput = document.getElementById("msg");
const emojiBtn = document.getElementById("emoji-btn");
const roomButtons = document.querySelectorAll(".room-btn");

let myId = Math.random().toString(36).slice(2);
let lastSend=0;
let currentRoom = "global";

// Emoji Picker
const picker = new EmojiButton.EmojiButton({ position: 'top-end' });
emojiBtn.addEventListener('click', () => picker.togglePicker(emojiBtn));
picker.on('emoji', emoji => msgInput.value += emoji);

// Profanity filter
function filter(text){
  const bad=["fuck","shit","bitch"];
  bad.forEach(w=>{text=text.replace(new RegExp(w,'gi'),"***")});
  return text;
}

// Load messages
async function load(){
  let { data } = await db.from("messages").select("*").eq("room",currentRoom).order("id",{ascending:true}).limit(200);
  chat.innerHTML="";
  data.forEach(show);
  chat.scrollTop = chat.scrollHeight;
}

// Show message
function show(m){
  let div = document.createElement("div");
  div.className = "msg"+(m.sender===myId?" me":"");
  div.innerHTML = `<div class="name">${m.name}</div>
    <div class="bubble">${m.message}</div>
    <div class="time">${new Date(m.created_at).toLocaleTimeString()}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// Realtime messages
db.channel("room-"+currentRoom)
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>{if(payload.new.room===currentRoom)show(payload.new)})
  .subscribe();

// Online users counter
async function updateUsers(){
  const name = nameInput.value||"Anon";
  await db.from("online_users").upsert({id:myId,name,room:currentRoom,last_seen:new Date()});
  const {data}=await db.from("online_users").select("*").eq("room",currentRoom);
  usersDiv.textContent = "Online: "+data.length;
}
setInterval(updateUsers,3000);

// Typing indicator
let typingTimeout;
msgInput.addEventListener("input",()=>{
  db.from("online_users").update({last_seen:new Date()}).eq("id",myId);
  db.from("online_users").select("*").eq("room",currentRoom).then(r=>{
    const othersTyping = r.data.filter(u=>u.id!==myId && msgInput.value.length>0);
    typingDiv.textContent = othersTyping.length ? "Someone is typing..." : "";
  });
});

// Send message
async function send(){
  if(Date.now()-lastSend<1500)return alert("Slow down!");
  lastSend=Date.now();
  const name=nameInput.value||"Anon";
  let msg=filter(msgInput.value);
  if(!msg) return;
  msgInput.value="";
  await db.from("messages").insert({name,message:msg,sender:myId,room:currentRoom});
}

// Room switching
roomButtons.forEach(btn=>{
  btn.addEventListener('click',async()=>{
    roomButtons.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentRoom = btn.dataset.room;
    await load();
  });
});

load();
</script>
</body>
</html>
